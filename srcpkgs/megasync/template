# Template file for 'megasync'
# Reference was taken from AUR and initially ibhagwan's megasync-template
# https://aur.archlinux.org/packages/megasync
# This template is going to be mirrored here as well:
# https://github.com/ibhagwan/megasync-template

pkgname=megasync
version=6.1.1.0
revision=1
_sdk_commit="1c13b13cb90c77f61e38d228b73a4a6fa8df67ca"
build_style=cmake
configure_args="-DCMAKE_BUILD_TYPE:STRING='None'
 -DCMAKE_MODULE_PATH:PATH='${XBPS_BUILDDIR}/${pkgname}-${version}/src/MEGASync/mega/cmake/modules/packages'
 -DCMAKE_SKIP_INSTALL_RPATH:BOOL='YES'
 -DENABLE_DESIGN_TOKENS_IMPORTER:BOOL='OFF'
 -Wno-dev
 -DUSE_PDFIUM=OFF
 -DCMAKE_INSTALL_PREFIX:PATH='/'
 -DENABLE_DESKTOP_APP_TESTS:BOOL='OFF'
 -DUSE_BREAKPAD='OFF'"
make_cmd=make
make_build_target="MEGAsync"
make_check_target="MEGAsync"
hostmakedepends="openssh pkg-config qt5-host-tools"
makedepends="qt5-tools-devel qt5-devel qt5-x11extras-devel qt5-svg-devel
 qt5-declarative-devel libraw-devel libgomp-devel freeimage-devel ffmpeg-devel
 readline-devel libmediainfo-devel libuv-devel c-ares-devel crypto++-devel
 libsodium-devel sqlite-devel"
short_desc="Automated syncing with MEGA Cloud Drive"
maintainer="Kevin Figueroa <kfdevart@disroot.org>"
license="custom:LicenseRef-Mega-Limited-Code-License"
homepage="https://mega.co.nz"
changelog="https://github.com/meganz/MEGAsync/releases/tag/v${version}_Linux"
distfiles="https://github.com/meganz/MEGAsync/archive/refs/tags/v${version}_Linux.tar.gz
 https://github.com/meganz/sdk/archive/${_sdk_commit}.tar.gz>mega-sdk-${_sdk_commit}.tar.gz
 https://raw.githubusercontent.com/meganz/sdk/${_sdk_commit}/.clang-format>clang-format-${_sdk_commit}"
checksum="@5033da64f16009d6286c6e48b3779f3304f872be237504cb85c135504f86a440
 @83ddf9d9bc448009c2f9d43a42476837bdc9cccda7f8aa72ab9b60debb4d8245
 0edced6d312b725485c57b93e666d9237aa692163210e215fc0dec99e0e74c7b"
restricted=yes
repository=nonfree
CXXFLAGS="-DNDEBUG"

skip_extraction="mega-sdk-${_sdk_commit}.tar.gz clang-format-${_sdk_commit}"

export CMAKE_GENERATOR="Unix Makefiles"

case "$XBPS_TARGET_MACHINE" in
	*-musl|ppc*) broken="google breakpad";;
esac

post_extract() {
	vsrcextract -C src/MEGASync/mega "mega-sdk-${_sdk_commit}.tar.gz"
	vsrccopy "clang-format-${_sdk_commit}" .
	mv "clang-format-${_sdk_commit}" .clang-format
}

post_install() {
	rm -rf ${DESTDIR}/opt
	vlicense LICENCE.md
	vlicense installer/terms.txt
	vlicense src/MEGASync/mega/LICENSE LICENCE-SDK
}
